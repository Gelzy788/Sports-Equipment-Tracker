{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2>Склад</h2>

    {% with messages = get_flashed_messages() %}
    {% if messages %}
    {% for message in messages %}
    <div class="alert alert-info alert-dismissible fade show">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    <button id="toggleMode" class="btn btn-primary mb-3" onclick="toggleMode()">Переключить на сбор инвентаря</button>

    <div id="giveInventory" class="mode">
        <h3 class="mt-4">Выдать инвентарь пользователю</h3>
        <form method="POST">
            <input type="hidden" name="action" value="give">
            <select name="storage_id" required>
                {% for item in items %}
                <option value="{{ item.id }}">
                    {{ item.name }} ({{ item.count }})
                    {% if item.status == 'сломано' %}
                        [Сломано]
                    {% else %}
                        [Новое]
                    {% endif %}
                </option>
                {% endfor %}
            </select>

            <select name="user_id" required>
                {% for user in users %}
                <option value="{{ user.id }}">{{ user.username }}</option>
                {% endfor %}
            </select>

            <input type="number" name="quantity" min="1" placeholder="Количество" required>

            <button type="submit">Выдать</button>
        </form>
    </div>

    <div id="takeBackInventory" class="mode" style="display: none;">
        <h3 class="mt-4">Забрать инвентарь у пользователя</h3>
        <form method="POST">
            <input type="hidden" name="action" value="take_back">
            <select name="user_id" id="userSelect" onchange="showUserInventory(this.value)" required>
                {% for user in users %}
                <option value="{{ user.id }}">{{ user.username }}</option>
                {% endfor %}
            </select>

            <select name="equipment_id" required>
                {% for item in items %}
                <option value="{{ item.id }}">{{ item.name }}</option>
                {% endfor %}
            </select>

            <input type="number" name="quantity" min="1" placeholder="Количество" required>

            <button type="submit">Забрать</button>
        </form>

        <h4 class="mt-4">Инвентарь выбранного пользователя</h4>
        <div id="userInventory"></div>
    </div>

    <h3 class="mt-4">Инвентарь на складе</h3>
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead class="thead-dark">
                <tr>
                    <th>Наименование</th>
                    <th>Количество</th>
                    {% if current_user.admin %}
                    <th>Действия</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for item in items %}
                <tr>
                    <td>{{ item.name }}</td>
                    <td>{{ item.count }}</td>
                    {% if current_user.admin %}
                    <td>
                        <a href="{{ url_for('edit_item', item_id=item.id) }}"
                            class="btn btn-sm btn-primary">Редактировать</a>
                        <button class="btn btn-sm btn-danger" onclick="deleteItem('{{ item.id }}')">Удалить</button>
                    </td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% if current_user.admin %}
    <div class="mt-3">
        <a href="{{ url_for('add_item') }}" class="btn btn-success">Добавить новый предмет</a>
    </div>
    {% endif %}
</div>

{% if current_user.admin %}
<script>
    function toggleMode() {
        const giveInventory = document.getElementById('giveInventory');
        const takeBackInventory = document.getElementById('takeBackInventory');
        const toggleButton = document.getElementById('toggleMode');

        if (giveInventory.style.display === 'none') {
            giveInventory.style.display = 'block';
            takeBackInventory.style.display = 'none';
            toggleButton.innerText = 'Переключить на сбор инвентаря';
        } else {
            giveInventory.style.display = 'none';
            takeBackInventory.style.display = 'block';
            toggleButton.innerText = 'Переключить на выдачу инвентаря';
        }
    }

    function showUserInventory(userId) {
        fetch(`/user_inventory/${userId}`)
            .then(response => response.json())
            .then(data => {
                const userInventoryDiv = document.getElementById('userInventory');
                userInventoryDiv.innerHTML = ''; // Очистить предыдущий инвентарь

                if (data.equipment.length > 0) {
                    const table = document.createElement('table');
                    table.className = 'table table-striped';
                    const header = table.createTHead();
                    const headerRow = header.insertRow(0);
                    headerRow.insertCell(0).innerText = 'ID предмета';
                    headerRow.insertCell(1).innerText = 'Наименование';
                    headerRow.insertCell(2).innerText = 'Количество';

                    const body = table.createTBody();
                    data.equipment.forEach(item => {
                        const row = body.insertRow();
                        row.insertCell(0).innerText = item.equipment_id;
                        row.insertCell(1).innerText = item.storage.name;
                        row.insertCell(2).innerText = item.count;
                    });

                    userInventoryDiv.appendChild(table);
                } else {
                    userInventoryDiv.innerText = 'У пользователя нет инвентаря.';
                }
            });
    }
</script>
{% endif %}
{% endblock %}